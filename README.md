# Broker demo for gitlab local

Snyk Broker set up for locally running GitLab. 
This demo locally runs 2 containers, GitLab and Snyk Broker.
Snyk broker proxies the connection between local GitLab and Snyk platform.

## Pre-requisite

You need local DNS server (or /etc/hosts) and CA for issuing locally trusted certificate for HTTPS.

#### Local DNS server

Host name resolution could be done by ediding /etc/hosts, but it always nice to have your own local DNS server ;-)
Below is example to resolve `*.test` as a local loopback address.

```shell
brew install dnsmasq

# set *.test domain as a local loopback address
echo 'address=/.test/127.0.0.1' >> $(brew --prefix)/etc/dnsmasq.conf

# Make dnsmasq as local DNS for *.test domain
sudo mkdir -v /etc/resolver
sudo bash -c 'echo "nameserver 127.0.0.1" >> /etc/resolver/test'

# Start dnsmasq
sudo brew services start dnsmasq
```

To test if DNS is working, try:
```
ping snyk.test
ping gitlab.test
```

It should route to localhost.


#### Local CA

You need locally trusted cert for GitLab server.

```shell
brew install mkcert
mkcert -install # Set up local CA and generate CA cert 
mkcert <hostname> # Generated signed cert for hostname, IP, wildcard, etc
```

If you want to issue a cert for multiple SANS, try:
```
mkcert gitlab.test localhost 127.0.0.1
```

## ToDos
[_] Snyk broker demo set up
* [done][2022/07/13] set up local GitLab (docker)
    * https://qiita.com/suzukihi724/items/55de461d8cdfa3459f11
    * https://docs.gitlab.com/ee/install/docker.html
    * https://hub.docker.com/r/yrzr/gitlab-ce-arm64v8
    * M1 Macの場合、Arm64で作られたコンテナじゃないと動かないっぽい？
* Gitlab container registryの有効化
    * Initial Root passwdの取得
        * https://mebee.info/2022/04/15/post-65562/
        * docker exec -it gitlab grep 'Password:' /etc/gitlab/initial_root_password
[_] HTTPS
* https://docs.gitlab.com/omnibus/settings/nginx.html#manually-configuring-https
    * Certs can also generated by Mac’s keychain access
        * Needs to translate der to pem 
            * How do I convert a .cer certificate to .pem? - Server Fault
                * openssl x509 -inform der -in certificate.cer -outform pem -out certificate.pem
            * Also private key as well
                * Converting PKCS#12 certificate into PEM using OpenSSL - Stack Overflow
    * Install and configure the Snyk Broker client
        * Brokerに以下の設定が必要（自己証明書のため）
            * -e NODE_TLS_REJECT_UNAUTHORIZED=0　　＃TLSチェック無効化
    * Mkcert
        ``` shell
        mkcert localhost
        ```

[done] SCM Broker setup
* https://docs.google.com/presentation/d/1Kigk2FTKDEHB0-5kjh24g8wkxIGV_v6A0MxwSFVETzQ/edit#slide=id.g7f87d73857_0_125
    * [done] SCM connection
    * [done] ローカル環境からGitLabのRepoにアクセスできる確認

[____] Container registry
* GitLab Container Registry を有効化して、Dockerから利用する - Qiita
